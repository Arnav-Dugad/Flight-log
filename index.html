<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Arnav - My Flight Log - Interactive Globe</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet"> <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/globe.gl@2.30.0/dist/globe.gl.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            background-color: #000;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        /* Glassmorphism Utilities */
        .glass {
            background: rgba(20, 20, 20, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-panel {
            background: rgba(10, 10, 14, 0.9); /* Slightly darker for better contrast on mobile */
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
        }
        /* Form Elements */
        select, 
        input[type="date"], 
        input[type="time"],
        input[type="text"], 
        input[type="number"], 
        input[type="range"], 
        input[type="search"],
        input:not([type]) { 
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            outline: none;
            font-family: inherit;
        }
        select:focus, input:focus {
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.1);
        }
        select option {
            background: #1a1a1a;
            color: white;
        }
        
        /* Remove arrows from number input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* Mobile specific fixes */
        @media (max-width: 768px) {
            /* Prevent iOS zoom on inputs */
            input, select, textarea {
                font-size: 16px !important;
            }
            .glass-panel {
                border-right: none;
                border-bottom: none; /* Removed bottom border for full drawer feel */
            }
            /* Safe Area Support */
            .safe-pt {
                padding-top: env(safe-area-inset-top, 20px);
            }
            .safe-pb {
                padding-bottom: env(safe-area-inset-bottom, 20px);
            }
        }
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        /* Custom flight card hover */
        .flight-card {
            transition: all 0.2s ease;
        }
        .flight-card:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }
        .flight-card.active-card {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        #globeViz {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; 
            transition: opacity 1s ease;
        }
        /* Screensaver Mode */
        body.screensaver #ui-layer {
            opacity: 0;
            pointer-events: none;
        }
        body.screensaver #globeViz {
            cursor: none;
        }
        .interactive {
            pointer-events: auto;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .flight-card:hover .delete-btn {
            opacity: 1;
        }
        /* Always show delete on mobile for easier access */
        @media (max-width: 768px) {
            .delete-btn { opacity: 1; }
        }
        /* Sidebar Transition */
        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #sidebar.collapsed {
            transform: translateX(-100%);
        }
        /* Modal Transitions */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        .modal.hidden-modal {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        /* Airline Dropdown Styles */
        .airline-option {
            transition: background 0.2s;
        }
        .airline-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        /* Passport Styles */
        .passport-card {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier Prime', monospace;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        /* Fixed Stamp Styles */
        .stamp {
            font-family: 'Permanent Marker', cursive;
            border: 3px double currentColor;
            opacity: 0.9;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        /* Barrel Roll Animation */
        @keyframes barrelRoll {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .barrel-rolling {
            animation: barrelRoll 1s ease-in-out;
        }
    </style>
</head>
<body class="text-white">
    <div id="globeViz"></div>
    <div id="ui-layer" class="flex flex-col md:flex-row">
        
        <div class="absolute top-4 left-4 md:top-6 md:left-6 interactive z-50 safe-pt">
             <button onclick="toggleSidebar()" id="expand-btn" class="hidden p-3 rounded-full glass hover:bg-white/10 text-white transition-colors shadow-xl active:scale-95 cursor-pointer">
                <i class="ph-bold ph-list text-lg"></i>
            </button>
        </div>
        <div class="interactive glass-panel fixed md:relative top-0 left-0 h-full w-[85vw] md:w-96 flex flex-col shadow-2xl z-40 transition-transform duration-300 transform md:translate-x-0" id="sidebar">
            <div class="p-3 md:p-4 border-b border-white/10 flex justify-between items-center bg-black/20 safe-pt">
                <div>
                    <h1 class="text-lg md:text-xl font-semibold tracking-tight text-blue-100 flex items-center gap-2">
                        <i id="plane-icon" class="ph-fill ph-airplane-tilt text-blue-500 cursor-pointer hover:text-blue-400 hover:rotate-45 transition-all duration-300" onclick="triggerBarrelRoll()" title="Do a barrel roll!"></i>
                        Travel Log
                    </h1>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="toggleStats()" class="p-2 rounded-full hover:bg-white/10 transition-colors text-gray-400 hover:text-white cursor-pointer" title="Advanced Statistics">
                        <i class="ph-bold ph-chart-bar text-lg"></i>
                    </button>
                    <button onclick="openPassport()" class="p-2 rounded-full hover:bg-white/10 transition-colors text-gray-400 hover:text-white cursor-pointer" title="Aviation Passport">
                        <i class="ph-bold ph-identification-card text-lg"></i>
                    </button>
                    <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-white/10 transition-colors text-gray-400 hover:text-white cursor-pointer" title="Settings">
                        <i class="ph-bold ph-gear text-lg"></i>
                    </button>
                    <button onclick="toggleSidebar()" class="p-2 rounded-full hover:bg-white/10 transition-colors text-gray-400 hover:text-white cursor-pointer" title="Collapse Sidebar">
                        <i class="ph-bold ph-caret-double-left text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-2 p-2 md:p-3 border-b border-white/10 bg-white/5 shrink-0">
                <div class="text-center">
                    <div class="text-[10px] text-gray-400 uppercase tracking-wider">Flights</div>
                    <div class="text-base md:text-lg font-bold text-white" id="total-flights">0</div>
                </div>
                <div class="text-center border-l border-white/10 cursor-pointer hover:bg-white/5 transition-colors rounded" onclick="triggerMoonEasterEgg()" title="Click 5 times for a surprise!">
                    <div class="text-[10px] text-gray-400 uppercase tracking-wider">Distance</div>
                    <div class="text-base md:text-lg font-bold text-blue-400"><span id="total-km">0</span>k</div>
                </div>
                <div class="text-center border-l border-white/10">
                    <div class="text-[10px] text-gray-400 uppercase tracking-wider">Countries</div>
                    <div class="text-base md:text-lg font-bold text-emerald-400" id="total-countries">0</div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto min-h-0 flex flex-col">
                <div class="p-2 md:p-3 border-b border-white/10 bg-black/10 shrink-0">
                    <div class="space-y-2"> <div class="flex items-end gap-2">
                            <div class="flex-1 min-w-0">
                                <label class="text-[10px] text-gray-500 block mb-1">From</label>
                                <input list="airport-list" type="text" id="input-from" class="text-sm w-full uppercase py-1.5" placeholder="Origin">
                            </div>
                            <button onclick="swapAirports()" class="p-2 mb-1 rounded hover:bg-white/10 text-gray-400 hover:text-blue-400 transition-colors cursor-pointer" title="Swap">
                                <i class="ph-bold ph-arrows-left-right text-lg"></i>
                            </button>
                            <div class="flex-1 min-w-0">
                                <label class="text-[10px] text-gray-500 block mb-1">To</label>
                                <input list="airport-list" type="text" id="input-to" class="text-sm w-full uppercase py-1.5" placeholder="Dest">
                            </div>
                        </div>
                        
                        <datalist id="airport-list">
                            </datalist>
                        <div class="flex gap-2">
                             <div class="w-1/2">
                                <label class="text-[10px] text-gray-500 block mb-1">Date</label>
                                <input type="date" id="input-date" class="text-sm py-1.5">
                             </div>
                             <div class="w-1/2">
                                <label class="text-[10px] text-gray-500 block mb-1">Time</label>
                                <input type="time" id="input-time" class="text-sm py-1.5">
                             </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <div class="w-1/2">
                               <label class="text-[10px] text-gray-500 block mb-1">Flight #</label>
                               <input type="text" id="input-flight-num" class="text-sm py-1.5" placeholder="e.g. EK501">
                            </div>
                            <div class="w-1/2">
                               <label class="text-[10px] text-gray-500 block mb-1">Cost (INR)</label>
                               <input type="number" id="input-cost" class="text-sm py-1.5" placeholder="₹">
                            </div>
                        </div>
                        
                        <div class="relative">
                            <label class="text-[10px] text-gray-500 block mb-1">Airline</label>
                            <button onclick="toggleAirlineDropdown()" id="airline-btn" class="w-full text-left bg-white/5 border border-white/10 rounded-md py-1.5 px-3 text-sm flex items-center justify-between hover:bg-white/10 transition-colors cursor-pointer">
                                <span id="airline-btn-text" class="text-gray-400">Select Airline</span>
                                <i class="ph-bold ph-caret-down text-gray-500"></i>
                            </button>
                            
                            <div id="airline-dropdown" class="hidden absolute top-full left-0 right-0 mt-1 bg-[#1a1a1a] border border-white/10 rounded-md shadow-xl z-50 max-h-48 overflow-y-auto">
                                </div>
                            
                            <input type="hidden" id="input-airline">
                        </div>
                        <button onclick="addCustomFlight()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-md text-sm font-medium transition-colors shadow-lg shadow-blue-900/20 mt-1 active:scale-[0.98] cursor-pointer">
                            Add Flight
                        </button>
                    </div>
                </div>
                <div class="px-3 md:px-4 py-2 border-b border-white/10 bg-black/10 flex gap-2 items-center shrink-0">
                    <select id="year-filter" onchange="filterFlights()" class="text-xs bg-white/5 border-none w-auto max-w-[120px] py-1.5 cursor-pointer">
                        <option value="all">All Years</option>
                        </select>
                    <div class="flex-1"></div>
                    <div class="text-[10px] md:text-xs text-gray-500 flex items-center" id="filtered-count"></div>
                </div>
                <div class="flex-1 overflow-y-auto p-2 md:p-4 space-y-1.5 md:space-y-2 pb-20 md:pb-4 safe-pb" id="flight-list">
                    </div>
                
                <div class="p-2 border-t border-white/10 text-center bg-black/20 shrink-0 safe-pb">
                    <button onclick="clearAllFlights()" class="text-xs text-red-400 hover:text-red-300 transition-colors p-2 w-full cursor-pointer">
                        Clear All History
                    </button>
                </div>
            </div>
        </div>
        <div class="flex-1 relative pointer-events-none">
            
            <div id="settings-modal" class="modal hidden-modal absolute inset-0 flex items-center justify-center z-[60] pointer-events-auto bg-black/60 backdrop-blur-sm p-4">
                <div class="glass p-6 rounded-2xl w-full max-w-sm shadow-2xl transform transition-transform scale-100 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="ph-fill ph-gear"></i> Settings
                        </h2>
                        <button onclick="toggleSettings()" class="text-gray-400 hover:text-white p-2 cursor-pointer">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Map Theme</label>
                            <div class="flex gap-2 p-1 bg-white/5 rounded-lg">
                                <button onclick="setMapStyle('dark')" class="flex-1 py-2 text-xs rounded-md bg-blue-600 text-white transition-all cursor-pointer" id="btn-theme-dark">Dark</button>
                                <button onclick="setMapStyle('light')" class="flex-1 py-2 text-xs rounded-md hover:bg-white/10 text-gray-400 transition-all cursor-pointer" id="btn-theme-light">Light</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Options</label>
                            <div class="space-y-2">
                                <label class="flex items-center justify-between p-3 rounded bg-white/5 hover:bg-white/10 cursor-pointer">
                                    <span class="text-sm">Show Airports</span>
                                    <input type="checkbox" checked onchange="toggleAirports(this)" class="accent-blue-500 w-4 h-4 cursor-pointer">
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Controls</label>
                            <button onclick="toggleGyro()" id="gyro-btn" class="w-full py-2 px-3 bg-white/5 hover:bg-white/10 rounded flex items-center justify-between text-sm transition-colors border border-white/5 cursor-pointer">
                                <span class="flex items-center gap-2"><i class="ph-bold ph-device-rotate"></i> Enable Motion</span>
                                <span class="text-[10px] text-gray-500 uppercase" id="gyro-status">OFF</span>
                            </button>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Auto-Rotation Speed</label>
                            <input type="range" min="0" max="20" value="6" class="w-full accent-blue-500 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="updateRotationSpeed(this.value)">
                        </div>
                        <div class="pt-4 border-t border-white/10">
                            <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Data Management</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="exportData()" class="py-3 px-3 bg-white/5 hover:bg-white/10 rounded flex items-center justify-center gap-2 text-xs transition-colors cursor-pointer">
                                    <i class="ph-bold ph-download-simple"></i> Export
                                </button>
                                <label class="py-3 px-3 bg-white/5 hover:bg-white/10 rounded flex items-center justify-center gap-2 text-xs transition-colors cursor-pointer">
                                    <i class="ph-bold ph-upload-simple"></i> Import
                                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="passport-modal" class="modal hidden-modal absolute inset-0 flex items-center justify-center z-[60] pointer-events-auto bg-black/80 backdrop-blur-md p-4">
                <div class="flex flex-col items-center gap-4 w-full max-w-[360px]">
                    <div id="passport-capture-area" class="passport-card w-full rounded-2xl overflow-hidden relative flex flex-col text-white p-6 shadow-2xl scale-95 md:scale-100 transform origin-center">
                        <div class="flex justify-between items-start mb-6 z-10">
                            <div class="flex items-center gap-2">
                                <i class="ph-fill ph-globe-hemisphere-west text-3xl text-blue-400"></i>
                                <div>
                                    <div class="text-[10px] uppercase tracking-[0.2em] text-blue-200">Official Document</div>
                                    <div class="text-lg font-bold">AVIATION PASSPORT</div>
                                </div>
                            </div>
                            <div class="w-12 h-12 border border-white/20 rounded bg-white/5 flex items-center justify-center">
                                <i class="ph-fill ph-airplane-tilt text-2xl text-white/50"></i>
                            </div>
                        </div>
                        <div class="flex-1 z-10 space-y-4 mb-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-[9px] text-gray-400 uppercase mb-1 flex items-center gap-1"><i class="ph-bold ph-path"></i> Total Distance</div>
                                    <div class="text-xl font-bold text-blue-300" id="pass-dist">--</div>
                                </div>
                                <div>
                                    <div class="text-[9px] text-gray-400 uppercase mb-1 flex items-center gap-1"><i class="ph-bold ph-airplane-takeoff"></i> Flights</div>
                                    <div class="text-xl font-bold text-white" id="pass-flights">--</div>
                                </div>
                            </div>
                            <div>
                                <div class="text-[9px] text-gray-400 uppercase mb-1 flex items-center gap-1"><i class="ph-bold ph-star"></i> Favorite Airline</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <img id="pass-airline-logo" class="w-6 h-6 object-contain hidden">
                                    <div class="text-lg font-bold text-yellow-400" id="pass-airline">--</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-[9px] text-gray-400 uppercase mb-1 flex items-center gap-1"><i class="ph-bold ph-flag-banner"></i> Countries</div>
                                    <div class="text-lg font-bold text-emerald-400" id="pass-countries">--</div>
                                </div>
                                <div>
                                    <div class="text-[9px] text-gray-400 uppercase mb-1 flex items-center gap-1"><i class="ph-bold ph-wallet"></i> Total Value</div>
                                    <div class="text-sm font-bold text-white tracking-wide" id="pass-total-cost">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-white/10 z-10">
                            <div class="text-[9px] text-gray-400 uppercase mb-2">Entry Stamps</div>
                            <div class="grid grid-cols-4 gap-2" id="pass-stamps">
                                </div>
                        </div>
                        <div class="mt-6 pt-2 border-t border-white/10 flex justify-between items-end z-10">
                            <div class="font-mono text-[9px] text-gray-500">
                                ID: <span id="pass-id">FL-8392-X</span>
                            </div>
                            <img id="passport-qr-img" alt="Passport QR" title="Click to expand" onclick="openQrViewer()" class="w-28 h-28 bg-white rounded shadow-md shadow-black/30 transition-opacity duration-300 cursor-pointer" />
                        </div>
                    </div>
                    <div class="flex gap-3 w-full justify-center">
                        <button onclick="downloadPassport()" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-full font-medium shadow-lg transition-colors flex items-center gap-2 text-sm cursor-pointer">
                            <i class="ph-bold ph-download-simple"></i> Save
                        </button>
                        <button onclick="closePassport()" class="px-4 py-3 bg-white/10 hover:bg-white/20 rounded-full transition-colors text-sm cursor-pointer">
                            Close
                        </button>
                    </div>
                </div>
            </div>
            <div id="qr-viewer-modal" class="modal hidden-modal absolute inset-0 flex items-center justify-center z-[65] pointer-events-auto bg-black/80 backdrop-blur-md p-4">
                <div class="glass p-5 rounded-2xl w-full max-w-sm shadow-2xl">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-sm font-semibold flex items-center gap-2">
                            <i class="ph-fill ph-qr-code"></i> Passport QR
                        </div>
                        <button onclick="closeQrViewer()" class="text-gray-400 hover:text-white p-2 cursor-pointer">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>
                    </div>
                    <div class="flex flex-col items-center gap-3">
                        <img id="qr-viewer-img" alt="Expanded QR" class="w-full max-w-[250px] aspect-square bg-white rounded-lg shadow-md" />
                        <div class="w-full">
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">Encoded payload</div>
                            <pre id="qr-viewer-text" class="text-[10px] leading-snug whitespace-pre-wrap break-words bg-black/30 border border-white/10 rounded-lg p-3 max-h-28 overflow-auto"></pre>
                            <div class="flex gap-2 mt-2">
                                <button onclick="copyQrPayload()" class="flex-1 py-3 px-3 bg-white/10 hover:bg-white/20 rounded-lg text-xs transition-colors flex items-center justify-center gap-2 cursor-pointer">
                                    <i class="ph-bold ph-copy"></i> Copy
                                </button>
                                <button onclick="downloadQrPng()" class="flex-1 py-3 px-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-xs transition-colors flex items-center justify-center gap-2 cursor-pointer">
                                    <i class="ph-bold ph-download-simple"></i> Save
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="stats-modal" class="modal hidden-modal absolute inset-0 flex items-center justify-center z-[60] pointer-events-auto bg-black/60 backdrop-blur-sm p-4">
                <div class="glass p-5 md:p-6 rounded-2xl w-full max-w-2xl shadow-2xl transform transition-transform scale-100 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="ph-fill ph-chart-bar"></i> Global Statistics
                        </h2>
                        <button onclick="toggleStats()" class="text-gray-400 hover:text-white p-2 cursor-pointer">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>
                    </div>
                    <div class="space-y-6">
                         <div class="grid grid-cols-3 gap-2 md:gap-3">
                             <div class="p-3 bg-white/5 rounded-lg flex flex-col justify-center text-center md:text-left">
                                 <div class="text-[9px] md:text-[10px] text-gray-400 uppercase truncate flex flex-col md:flex-row items-center gap-1 justify-center md:justify-start">
                                    <i class="ph-fill ph-tree text-emerald-400"></i> <span>Carbon</span>
                                </div>
                                 <div class="text-xs md:text-sm font-bold text-red-400 mt-1 truncate" id="stat-co2">--</div>
                                 <div class="text-[8px] md:text-[9px] text-emerald-400 mt-0.5" id="stat-trees">-- trees</div>
                             </div>
                             <div class="p-3 bg-white/5 rounded-lg flex flex-col justify-center text-center md:text-left">
                                 <div class="text-[9px] md:text-[10px] text-gray-400 uppercase truncate flex flex-col md:flex-row items-center gap-1 justify-center md:justify-start">
                                    <i class="ph-bold ph-currency-inr text-yellow-400"></i> <span>Spent</span>
                                </div>
                                 <div class="text-xs md:text-sm font-bold text-white mt-1 truncate" id="stat-total-spent">₹0</div>
                                 <div class="text-[8px] md:text-[9px] text-gray-400 mt-0.5" id="stat-cost-km">₹0 / km</div>
                             </div>
                             <div class="p-3 bg-white/5 rounded-lg flex flex-col justify-center text-center md:text-left">
                                 <div class="text-[9px] md:text-[10px] text-gray-400 uppercase truncate flex flex-col md:flex-row items-center gap-1 justify-center md:justify-start">
                                    <i class="ph-bold ph-smiley"></i> <span>Vibe</span>
                                </div>
                                 <div class="text-xs md:text-sm font-bold text-blue-300 mt-1 truncate" id="stat-personality">--</div>
                             </div>
                         </div>
                         <div class="grid grid-cols-2 gap-3">
                             <div class="p-3 bg-white/5 rounded-lg flex flex-col justify-center">
                                 <div class="text-[10px] text-gray-400 uppercase truncate flex items-center gap-1"><i class="ph-bold ph-warning"></i> Brutal Hop</div>
                                 <div class="text-sm font-bold text-orange-400 mt-1 truncate" id="stat-brutal-hop">--</div>
                                 <div class="text-[9px] text-gray-500 truncate" id="stat-brutal-hop-val"></div>
                             </div>
                             <div class="p-3 bg-white/5 rounded-lg flex flex-col justify-center">
                                 <div class="text-[10px] text-gray-400 uppercase truncate flex items-center gap-1"><i class="ph-bold ph-hourglass"></i> Tight Connect</div>
                                 <div class="text-sm font-bold text-purple-300 mt-1 truncate" id="stat-tight-conn">--</div>
                                 <div class="text-[9px] text-gray-500 truncate" id="stat-tight-conn-val"></div>
                             </div>
                         </div>
                         <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-white/5 rounded-lg">
                                <div class="text-[10px] text-gray-400 uppercase flex items-center gap-1"><i class="ph-bold ph-arrows-out-line-horizontal"></i> Longest</div>
                                <div class="text-sm font-bold text-blue-400 mt-1 truncate" id="stat-longest">--</div>
                                <div class="text-[10px] text-gray-500 truncate" id="stat-longest-dist"></div>
                            </div>
                            <div class="p-3 bg-white/5 rounded-lg">
                                <div class="text-[10px] text-gray-400 uppercase flex items-center gap-1"><i class="ph-bold ph-arrows-in-line-horizontal"></i> Shortest</div>
                                <div class="text-sm font-bold text-emerald-400 mt-1 truncate" id="stat-shortest">--</div>
                                <div class="text-[10px] text-gray-500 truncate" id="stat-shortest-dist"></div>
                            </div>
                         </div>
                         <div>
                             <h4 class="text-xs text-gray-400 uppercase tracking-wider mb-2">Achievements</h4>
                             <div class="grid grid-cols-2 gap-2" id="achievements-grid">
                                 </div>
                         </div>
                         <div>
                             <h4 class="text-xs text-gray-400 uppercase tracking-wider mb-2">Regions</h4>
                             <div id="region-bars" class="space-y-2">
                                 </div>
                         </div>
                        <div>
                            <h4 class="text-xs text-gray-400 uppercase tracking-wider mb-2">Top Hubs</h4>
                            <div id="stats-airports" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="absolute top-4 right-4 md:top-6 md:right-6 flex flex-col gap-3 interactive z-50 safe-pt">
                <div class="glass rounded-xl p-1 flex flex-col gap-1">
                    <button onclick="zoomToHome()" class="p-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition-colors active:bg-white/20 cursor-pointer" title="Home (India)">
                        <i class="ph-bold ph-house-line text-lg"></i>
                    </button>
                    <button onclick="fitToMap()" class="p-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition-colors active:bg-white/20 cursor-pointer" title="Fit to Map">
                         <i class="ph-bold ph-frame-corners text-lg"></i>
                    </button>
                </div>
            </div>
            <div id="flight-info-tooltip" class="absolute bottom-10 md:bottom-12 left-4 right-4 md:left-1/2 md:right-auto md:transform md:-translate-x-1/2 glass rounded-xl border border-white/10 shadow-2xl shadow-blue-900/20 opacity-0 transition-opacity duration-300 flex flex-col overflow-hidden pointer-events-none z-40 max-w-lg mx-auto safe-pb">
                <div class="bg-white/5 p-3 flex justify-between items-center border-b border-white/5">
                    <div class="flex items-center gap-2">
                        <img id="info-airline-logo" class="w-5 h-5 object-contain hidden rounded-sm" alt="">
                        <span class="text-xs font-bold text-gray-200 tracking-wide" id="info-airline">Airline</span>
                    </div>
                    <div class="flex items-center gap-3 text-[10px] font-mono">
                        <span id="info-date" class="text-gray-400"></span>
                        <span id="info-time" class="text-blue-300 bg-blue-500/10 px-1.5 py-0.5 rounded"></span>
                    </div>
                </div>
                
                <div class="p-4 flex items-center justify-between gap-2 bg-black/40 backdrop-blur-xl">
                    <div class="text-center min-w-[50px]">
                        <div class="text-2xl md:text-3xl font-bold text-white tracking-tight leading-none" id="info-from-code">JFK</div>
                        <div class="text-[9px] text-gray-500 uppercase tracking-widest mt-1 truncate max-w-[80px] mx-auto" id="info-from-city">New York</div>
                    </div>
                    
                    <div class="flex flex-col items-center flex-1 px-2">
                        <div class="text-[9px] text-gray-500 font-mono mb-1" id="info-flight-num"></div>
                        <div class="flex items-center gap-2 w-full">
                            <div class="h-[1px] bg-gradient-to-r from-transparent via-blue-500/50 to-transparent flex-1"></div>
                            <i class="ph-fill ph-airplane text-blue-400 transform rotate-90 text-sm"></i>
                            <div class="h-[1px] bg-gradient-to-r from-transparent via-blue-500/50 to-transparent flex-1"></div>
                        </div>
                         <div class="text-[9px] text-blue-300 mt-1 font-mono" id="info-dist">5,400 km</div>
                         <div id="info-cost" class="text-[10px] text-green-400 font-mono mt-1 bg-green-900/20 px-1.5 py-0.5 rounded border border-green-500/20 inline-block hidden"></div>
                    </div>
                    <div class="text-center min-w-[50px]">
                        <div class="text-2xl md:text-3xl font-bold text-white tracking-tight leading-none" id="info-to-code">LHR</div>
                        <div class="text-[9px] text-gray-500 uppercase tracking-widest mt-1 truncate max-w-[80px] mx-auto" id="info-to-city">London</div>
                    </div>
                </div>
            </div>
            <div class="absolute bottom-2 w-full text-center z-0 pointer-events-none safe-pb">
                <span class="text-[9px] md:text-[10px] text-white/20 font-mono tracking-widest uppercase">© 2025 Arnav Dugad</span>
            </div>
        </div>
    </div>
    <script>
        // --- Safe DOM Update Helper ---
        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }
        // --- Data: Expanded Airport Database with Continent Mapping ---
        const airports = {
            "JFK": { lat: 40.6413, lng: -73.7781, city: "New York", country: "USA", region: "NA" },
            "LHR": { lat: 51.4700, lng: -0.4543, city: "London", country: "UK", region: "EU" },
            "HND": { lat: 35.5494, lng: 139.7798, city: "Tokyo", country: "Japan", region: "AS" },
            "DXB": { lat: 25.2532, lng: 55.3657, city: "Dubai", country: "UAE", region: "AS" },
            "SIN": { lat: 1.3644, lng: 103.9915, city: "Singapore", country: "Singapore", region: "AS" },
            "SYD": { lat: -33.9399, lng: 151.1753, city: "Sydney", country: "Australia", region: "OC" },
            "CDG": { lat: 49.0097, lng: 2.5479, city: "Paris", country: "France", region: "EU" },
            "SFO": { lat: 37.6213, lng: -122.3790, city: "San Francisco", country: "USA", region: "NA" },
            "GRU": { lat: -23.4356, lng: -46.4731, city: "São Paulo", country: "Brazil", region: "SA" },
            "CPT": { lat: -33.9715, lng: 18.6021, city: "Cape Town", country: "South Africa", region: "AF" },
            "BOM": { lat: 19.0896, lng: 72.8656, city: "Mumbai", country: "India", region: "AS" },
            "HKG": { lat: 22.3080, lng: 113.9185, city: "Hong Kong", country: "China", region: "AS" },
            "LAX": { lat: 33.9416, lng: -118.4085, city: "Los Angeles", country: "USA", region: "NA" },
            "ORD": { lat: 41.9742, lng: -87.9073, city: "Chicago", country: "USA", region: "NA" },
            "DFW": { lat: 32.8998, lng: -97.0403, city: "Dallas", country: "USA", region: "NA" },
            "DEN": { lat: 39.8561, lng: -104.6737, city: "Denver", country: "USA", region: "NA" },
            "IST": { lat: 41.2753, lng: 28.7519, city: "Istanbul", country: "Turkey", region: "EU" },
            "AMS": { lat: 52.3105, lng: 4.7683, city: "Amsterdam", country: "Netherlands", region: "EU" },
            "FRA": { lat: 50.0379, lng: 8.5622, city: "Frankfurt", country: "Germany", region: "EU" },
            "MAD": { lat: 40.4839, lng: -3.5679, city: "Madrid", country: "Spain", region: "EU" },
            "BCN": { lat: 41.2974, lng: 2.0833, city: "Barcelona", country: "Spain", region: "EU" },
            "ICN": { lat: 37.4602, lng: 126.4407, city: "Seoul", country: "South Korea", region: "AS" },
            "BKK": { lat: 13.6900, lng: 100.7501, city: "Bangkok", country: "Thailand", region: "AS" },
            "CAN": { lat: 23.3959, lng: 113.2971, city: "Guangzhou", country: "China", region: "AS" },
            "PEK": { lat: 40.0799, lng: 116.6031, city: "Beijing", country: "China", region: "AS" },
            "DEL": { lat: 28.5562, lng: 77.1000, city: "New Delhi", country: "India", region: "AS" },
            "CGK": { lat: -6.1275, lng: 106.6556, city: "Jakarta", country: "Indonesia", region: "AS" },
            "KUL": { lat: 2.7456, lng: 101.7072, city: "Kuala Lumpur", country: "Malaysia", region: "AS" },
            "YYZ": { lat: 43.6777, lng: -79.6248, city: "Toronto", country: "Canada", region: "NA" },
            "YVR": { lat: 49.1947, lng: -123.1762, city: "Vancouver", country: "Canada", region: "NA" },
            "MEX": { lat: 19.4361, lng: -99.0719, city: "Mexico City", country: "Mexico", region: "NA" },
            "BOG": { lat: 4.7016, lng: -74.1469, city: "Bogota", country: "Colombia", region: "SA" },
            "EZE": { lat: -34.8150, lng: -58.5348, city: "Buenos Aires", country: "Argentina", region: "SA" },
            "JNB": { lat: -26.1367, lng: 28.2411, city: "Johannesburg", country: "South Africa", region: "AF" },
            "CAI": { lat: 30.1219, lng: 31.4056, city: "Cairo", country: "Egypt", region: "AF" },
            "MEL": { lat: -37.6690, lng: 144.8410, city: "Melbourne", country: "Australia", region: "OC" },
            "AKL": { lat: -37.0082, lng: 174.7850, city: "Auckland", country: "New Zealand", region: "OC" },
            "DOH": { lat: 25.2731, lng: 51.6081, city: "Doha", country: "Qatar", region: "AS" },
            "AUH": { lat: 24.4448, lng: 54.6467, city: "Abu Dhabi", country: "UAE", region: "AS" },
            "MUC": { lat: 48.3537, lng: 11.7750, city: "Munich", country: "Germany", region: "EU" },
            "ZRH": { lat: 47.4582, lng: 8.5555, city: "Zurich", country: "Switzerland", region: "EU" },
            "FCO": { lat: 41.8003, lng: 12.2389, city: "Rome", country: "Italy", region: "EU" },
            "DUB": { lat: 53.4264, lng: -6.2499, city: "Dublin", country: "Ireland", region: "EU" },
            "IXE": { lat: 12.9613, lng: 74.8901, city: "Mangalore", country: "India", region: "AS" },
            "BLR": { lat: 13.1986, lng: 77.7066, city: "Bangalore", country: "India", region: "AS" },
            "IDR": { lat: 22.7232, lng: 75.8011, city: "Indore", country: "India", region: "AS" },
            "JAI": { lat: 26.8286, lng: 75.8056, city: "Jaipur", country: "India", region: "AS" },
            "DMM": { lat: 26.4716, lng: 49.7978, city: "Dammam", country: "Saudi Arabia", region: "AS" },
            "BAH": { lat: 26.2708, lng: 50.6336, city: "Manama", country: "Bahrain", region: "AS" },
            "HYD": { lat: 17.2403, lng: 78.4294, city: "Hyderabad", country: "India", region: "AS" }
        };
        const airlinesData = [
            { name: "Air India Express", logo: "https://pics.avs.io/200/200/IX.png" },
            { name: "Air India", logo: "https://pics.avs.io/200/200/AI.png" },
            { name: "IndiGo", logo: "https://pics.avs.io/200/200/6E.png" },
            { name: "Etihad", logo: "https://pics.avs.io/200/200/EY.png" },
            { name: "Emirates", logo: "https://pics.avs.io/200/200/EK.png" },
            { name: "Saudia", logo: "https://pics.avs.io/200/200/SV.png" },
            { name: "Air Arabia", logo: "https://pics.avs.io/200/200/G9.png" },
            { name: "Gulf Air", logo: "https://pics.avs.io/200/200/GF.png" },
            { name: "Qatar Airways", logo: "https://pics.avs.io/200/200/QR.png" }
        ];
        // Initial Flights Data
        let allFlights = [
            { from: "SFO", to: "HND", date: "2023-05-12", time: "10:00", airline: "Air India", flightNum: "AI101", cost: 65000 },
            { from: "HND", to: "SIN", date: "2023-05-20", time: "14:30", airline: "IndiGo", flightNum: "6E55", cost: 25000 },
            { from: "SIN", to: "DXB", date: "2023-06-01", time: "02:15", airline: "Emirates", flightNum: "EK354", cost: 42000 },
            { from: "DXB", to: "LHR", date: "2023-06-05", time: "08:45", airline: "Etihad", flightNum: "EY11", cost: 38000 },
            { from: "LHR", to: "JFK", date: "2023-11-15", time: "18:20", airline: "Qatar Airways", flightNum: "QR7", cost: 55000 }
        ];
        
        let displayFlights = [...allFlights];
        // --- Globe Initialization ---
        const globeContainer = document.getElementById('globeViz');
        let world;
        let autoRotate = true;
        let showAirports = true;
        let hoveredFlightId = null; 
        let lockedFlightId = null; // New state for locked selection
        function initGlobe() {
            if (typeof Globe === 'undefined') {
                setTimeout(initGlobe, 100);
                return;
            }
            // Mobile-first check
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                const expandBtn = document.getElementById('expand-btn');
                if (sidebar) sidebar.classList.add('collapsed');
                if (expandBtn) { expandBtn.classList.remove('hidden'); expandBtn.classList.add('flex'); }
            }
            world = Globe()
                (globeContainer)
                .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
                .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
                .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
                
                // Arc (Flight) Styling - Thinner arcs
                .arcColor(d => {
                    const isActive = d.id === lockedFlightId || (hoveredFlightId !== null && d.id === hoveredFlightId);
                    if (lockedFlightId !== null) {
                        return isActive ? '#FFD700' : 'rgba(255,255,255,0.02)'; // Dim others heavily when locked
                    }
                    if (hoveredFlightId !== null) {
                        return isActive ? '#FFD700' : 'rgba(255,255,255,0.05)';
                    }
                    return d.color;
                })
                .arcStroke(d => {
                    const isActive = d.id === lockedFlightId || d.id === hoveredFlightId;
                    return isActive ? 2.0 : 1.0; 
                })
                .arcAltitude(d => {
                    const isActive = d.id === lockedFlightId || d.id === hoveredFlightId;
                    return isActive ? d.arcAlt * 1.2 : d.arcAlt;
                })
                .arcLabel(d => `Flight: ${d.from} → ${d.to}`)
                .onArcHover(hoverArc)
                .onArcClick(d => { 
                    focusFlight(displayFlights[d.id]); // Locks and highlights
                })
                .onGlobeClick(() => {
                    // Unlock on background click
                    lockedFlightId = null;
                    if(autoRotate) world.controls().autoRotate = true;
                    hoveredFlightId = null;
                    updateGlobeData();
                    // Clear tooltip
                    const tooltip = document.getElementById('flight-info-tooltip');
                    if(tooltip) tooltip.classList.add('opacity-0');
                    // Reset card styles
                    document.querySelectorAll('.flight-card').forEach(el => el.classList.remove('active-card'));
                })
                // Point (Airport) Styling
                .pointColor(() => '#4ade80') 
                .pointAltitude(0.02)
                .pointRadius(0.3)
                .pointResolution(20) 
                .pointLabel(d => `${d.city} (${d.code})`)
                .onPointClick(d => {
                    world.pointOfView({ lat: d.lat, lng: d.lng, altitude: 1.5 }, 1000);
                });
            world.pointOfView({ lat: 22, lng: 78, altitude: 2.0 });
            
            world.controls().autoRotate = true;
            world.controls().autoRotateSpeed = 0.6;
            populateDatalist();
            populateAirlineDropdown();
            populateYearFilter();
            updateGlobeData();
            updateUI();
            
            setupScreensaver();
        }
        // Initialize on load
        document.addEventListener('DOMContentLoaded', initGlobe);
        // --- Logic & Updates ---
        function populateDatalist() {
            const datalist = document.getElementById('airport-list');
            if(!datalist) return;
            const sortedCodes = Object.keys(airports).sort();
            datalist.innerHTML = '';
            sortedCodes.forEach(code => {
                const airport = airports[code];
                const option = document.createElement('option');
                option.value = `${code} - ${airport.city}`; 
                datalist.appendChild(option);
            });
            const dInput = document.getElementById('input-date');
            if(dInput) dInput.valueAsDate = new Date();
        }
        function populateAirlineDropdown() {
            const dropdown = document.getElementById('airline-dropdown');
            if(!dropdown) return;
            dropdown.innerHTML = '';
            airlinesData.forEach(al => {
                const div = document.createElement('div');
                div.className = "airline-option flex items-center gap-3 p-3 cursor-pointer border-b border-white/5 last:border-0";
                div.onclick = () => selectAirline(al.name);
                div.innerHTML = `
                    <img src="${al.logo}" alt="${al.name}" class="w-10 h-10 object-contain bg-white/10 rounded-full p-1">
                    <span class="text-sm text-gray-200">${al.name}</span>
                `;
                dropdown.appendChild(div);
            });
        }
        function populateYearFilter() {
            const yearSelect = document.getElementById('year-filter');
            if(!yearSelect) return;
            const years = new Set(allFlights.map(f => f.date.split('-')[0]).filter(Boolean));
            while(yearSelect.options.length > 1) yearSelect.remove(1);
            Array.from(years).sort().reverse().forEach(year => {
                const opt = document.createElement('option');
                opt.value = year; opt.text = year; yearSelect.add(opt);
            });
        }
        function filterFlights() {
            const yearFilter = document.getElementById('year-filter');
            if(!yearFilter) return;
            const year = yearFilter.value;
            if (year === 'all') {
                displayFlights = [...allFlights];
                setText('filtered-count', '');
            } else {
                displayFlights = allFlights.filter(f => f.date.startsWith(year));
                setText('filtered-count', `${displayFlights.length} flights in ${year}`);
            }
            updateGlobeData();
            updateUI();
        }
        function toggleAirlineDropdown() {
            const el = document.getElementById('airline-dropdown');
            if(el) el.classList.toggle('hidden');
        }
        function selectAirline(name) {
            const inp = document.getElementById('input-airline');
            if(inp) inp.value = name;
            setText('airline-btn-text', name);
            const btnText = document.getElementById('airline-btn-text');
            if(btnText) {
                btnText.classList.remove('text-gray-400');
                btnText.classList.add('text-white');
            }
            toggleAirlineDropdown();
        }
        
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('airline-dropdown');
            const btn = document.getElementById('airline-btn');
            if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });
        function swapAirports() {
            const fromInput = document.getElementById('input-from');
            const toInput = document.getElementById('input-to');
            if(fromInput && toInput) {
                const temp = fromInput.value;
                fromInput.value = toInput.value;
                toInput.value = temp;
            }
        }
        // --- Core Action Functions (Fixed) ---
        function addCustomFlight() {
            const fromVal = document.getElementById('input-from').value.split(' - ')[0].toUpperCase();
            const toVal = document.getElementById('input-to').value.split(' - ')[0].toUpperCase();
            const date = document.getElementById('input-date').value;
            const time = document.getElementById('input-time').value;
            const flightNum = document.getElementById('input-flight-num').value.toUpperCase();
            const cost = document.getElementById('input-cost').value;
            const airline = document.getElementById('input-airline').value;
            if (!airports[fromVal] || !airports[toVal]) {
                alert("Please select valid airports from the list.");
                return;
            }
            if (!date) {
                alert("Please select a date.");
                return;
            }
            const newFlight = {
                from: fromVal,
                to: toVal,
                date: date,
                time: time,
                flightNum: flightNum,
                cost: cost,
                airline: airline
            };
            allFlights.push(newFlight);
            // Reset filters to show new flight
            document.getElementById('year-filter').value = 'all';
            displayFlights = [...allFlights];
            
            populateYearFilter();
            updateGlobeData();
            updateUI();
            // Reset inputs
            document.getElementById('input-from').value = '';
            document.getElementById('input-to').value = '';
            document.getElementById('input-flight-num').value = '';
            document.getElementById('input-cost').value = '';
            // Reset Airline dropdown
            document.getElementById('input-airline').value = '';
            setText('airline-btn-text', 'Select Airline');
            document.getElementById('airline-btn-text').classList.add('text-gray-400');
        }
        function deleteFlight(originalIndex) {
            if(confirm("Are you sure you want to delete this flight?")) {
                allFlights.splice(originalIndex, 1);
                filterFlights(); // Re-apply current filter
                updateGlobeData();
                updateUI();
                populateYearFilter();
            }
        }
        function clearAllFlights() {
            if(confirm("Are you sure you want to clear ALL flight history? This cannot be undone.")) {
                allFlights = [];
                displayFlights = [];
                updateGlobeData();
                updateUI();
                populateYearFilter();
            }
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expandBtn = document.getElementById('expand-btn');
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                expandBtn.classList.remove('hidden');
                expandBtn.classList.add('flex');
            } else {
                expandBtn.classList.add('hidden');
                expandBtn.classList.remove('flex');
            }
        }
        function toggleStats() {
            const modal = document.getElementById('stats-modal');
            modal.classList.toggle('hidden-modal');
        }
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden-modal');
        }
        
        function updateRotationSpeed(val) {
            if(world) {
                world.controls().autoRotateSpeed = val / 10;
            }
        }
        // --- Interaction Logic (Fixed) ---
        function focusFlight(flight) {
            if (!flight) return;
            
            // Find flight ID
            const idx = displayFlights.indexOf(flight);
            if(idx === -1) return;
            lockedFlightId = idx;
            hoveredFlightId = idx;
            
            const start = airports[flight.from];
            const end = airports[flight.to];
            
            if(world && start && end) {
                // Calculate midpoint
                const lat = (start.lat + end.lat) / 2;
                // Simple avg for lng is tricky around 180, but sufficient here
                let lng = (start.lng + end.lng) / 2;
                // Handle dateline crossing roughly
                if (Math.abs(start.lng - end.lng) > 180) {
                    lng += 180;
                }
                world.pointOfView({ lat: lat, lng: lng, altitude: 1.8 }, 1500);
                world.controls().autoRotate = false;
            }
            // Highlight card
            document.querySelectorAll('.flight-card').forEach((el, i) => {
                if (i === idx) {
                    el.classList.add('active-card');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    el.classList.remove('active-card');
                }
            });
            // Show Tooltip
            updateTooltip(flight, start, end);
            updateGlobeData();
        }
        function hoverArc(arc) {
            if (lockedFlightId !== null) return; // Don't override lock
            if (arc) {
                hoveredFlightId = arc.id;
                const flight = displayFlights[arc.id];
                const start = airports[flight.from];
                const end = airports[flight.to];
                updateTooltip(flight, start, end);
                
                // Highlight card
                document.querySelectorAll('.flight-card').forEach((el, i) => {
                    if (i === arc.id) el.classList.add('active-card');
                    else el.classList.remove('active-card');
                });
            } else {
                hoveredFlightId = null;
                const tooltip = document.getElementById('flight-info-tooltip');
                if(tooltip) tooltip.classList.add('opacity-0');
                
                document.querySelectorAll('.flight-card').forEach(el => el.classList.remove('active-card'));
            }
            updateGlobeData();
        }
        function updateTooltip(flight, start, end) {
            const tooltip = document.getElementById('flight-info-tooltip');
            if(!tooltip) return;
            setText('info-airline', flight.airline || 'Unknown Airline');
            setText('info-date', flight.date);
            setText('info-time', flight.time || '');
            setText('info-from-code', flight.from);
            setText('info-from-city', start.city);
            setText('info-to-code', flight.to);
            setText('info-to-city', end.city);
            setText('info-flight-num', flight.flightNum || '');
            
            const distKm = Math.floor(6371 * getDistanceRadians(start.lat, start.lng, end.lat, end.lng));
            setText('info-dist', `${distKm.toLocaleString()} km`);
            const logoImg = document.getElementById('info-airline-logo');
            const airlineData = airlinesData.find(a => a.name === flight.airline);
            if (airlineData) {
                logoImg.src = airlineData.logo;
                logoImg.classList.remove('hidden');
            } else {
                logoImg.classList.add('hidden');
            }
            const costEl = document.getElementById('info-cost');
            if(flight.cost) {
                costEl.innerText = formatCurrency(flight.cost);
                costEl.classList.remove('hidden');
            } else {
                costEl.classList.add('hidden');
            }
            tooltip.classList.remove('opacity-0');
        }
        // --- Easter Eggs (Fixed) ---
        function triggerBarrelRoll() {
            const body = document.body;
            if(!body.classList.contains('barrel-rolling')) {
                // Apply rotation to the whole body or just globe? Applying to body is safer
                document.getElementById('globeViz').classList.add('barrel-rolling');
                setTimeout(() => {
                    document.getElementById('globeViz').classList.remove('barrel-rolling');
                }, 1000);
            }
        }
        let moonClicks = 0;
        function triggerMoonEasterEgg() {
            moonClicks++;
            if (moonClicks === 5) {
                alert("🚀 To the Moon! (Sort of...)");
                world.pointOfView({ altitude: 10 }, 2000); // Zoom way out
                moonClicks = 0;
            }
        }
        function getDistanceRadians(lat1, lng1, lat2, lng2) {
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const dPhi = (lat2 - lat1) * Math.PI / 180;
            const dLambda = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dPhi / 2) * Math.sin(dPhi / 2) + Math.cos(phi1) * Math.cos(phi2) * Math.sin(dLambda / 2) * Math.sin(dLambda / 2);
            return 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        function getArcData() {
            return displayFlights.map((f, idx) => {
                const start = airports[f.from];
                const end = airports[f.to];
                if (!start || !end) return null;
                
                const distRad = getDistanceRadians(start.lat, start.lng, end.lat, end.lng);
                const distKm = distRad * 6371;
                
                let alt = distRad * 0.35; 
                if (alt < 0.1) alt = 0.1;
                
                // Solid colors per user request
                let color;
                if (distKm < 2000) color = 'rgba(255, 255, 255, 0.4)'; 
                else if (distKm > 9000) color = '#FF4500'; 
                else color = 'rgba(60, 150, 255, 0.8)';
                return {
                    id: idx, 
                    startLat: start.lat,
                    startLng: start.lng,
                    endLat: end.lat,
                    endLng: end.lng,
                    from: f.from,
                    to: f.to,
                    date: f.date,
                    time: f.time, // Added time to arc data
                    airline: f.airline || '',
                    flightNum: f.flightNum || '',
                    cost: f.cost,
                    arcAlt: alt,
                    color: color
                };
            }).filter(Boolean);
        }
        function getPointData() {
            if (!showAirports) return [];
            const codes = new Set([...displayFlights.map(f => f.from), ...displayFlights.map(f => f.to)]);
            return Array.from(codes).map(code => ({ code, ...airports[code] }));
        }
        function updateGlobeData() {
            if (!world) return;
            // No arc animation by default per request
            world.arcDashLength(1) 
                 .arcDashGap(0)
                 .arcDashAnimateTime(0);
                 
            world.arcsData(getArcData());
            world.pointsData(getPointData());
            world.objectsData([]); 
        }
        function highlightFlight(index) {
            // Don't override locked flight on hover
            if (lockedFlightId !== null) return;
            hoveredFlightId = index;
            updateGlobeData();
            document.querySelectorAll('.flight-card').forEach((el, i) => {
                if (i === index) el.classList.add('active-card');
                else el.classList.remove('active-card');
            });
        }
        function unhighlightFlight() {
            if (lockedFlightId !== null) return;
            hoveredFlightId = null;
            updateGlobeData();
            document.querySelectorAll('.flight-card').forEach(el => el.classList.remove('active-card'));
        }
        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '₹--';
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(amount);
        }
        function updateUI() {
            const list = document.getElementById('flight-list');
            if(list) list.innerHTML = '';
            let kmTotal = 0;
            let totalCost = 0;
            const uniqueCountries = new Set();
            [...displayFlights].reverse().forEach((f, idx) => {
                const realIndex = displayFlights.indexOf(f); 
                const originalIndex = allFlights.indexOf(f); 
                const start = airports[f.from];
                const end = airports[f.to];
                if(start) uniqueCountries.add(start.country);
                if(end) uniqueCountries.add(end.country);
                const R = 6371; 
                const distRad = getDistanceRadians(start.lat, start.lng, end.lat, end.lng);
                const dist = Math.floor(R * distRad);
                kmTotal += dist;
                
                if (f.cost) totalCost += Number(f.cost);
                if(list) {
                    const card = document.createElement('div');
                    // Compact styling for mobile: p-2 instead of p-3, smaller gaps
                    card.className = 'flight-card glass rounded-xl cursor-pointer fade-in relative group overflow-hidden border border-white/5 hover:border-white/20 mb-1';
                    card.style.animationDelay = `${idx * 0.05}s`;
                    card.dataset.index = realIndex;
                    
                    card.onmouseenter = () => highlightFlight(realIndex);
                    card.onmouseleave = unhighlightFlight;
                    card.onclick = (e) => {
                        if(e.target.closest('.delete-btn')) return;
                        focusFlight(f);
                    };
                    
                    const airlineData = airlinesData.find(a => a.name === f.airline);
                    const logoHtml = airlineData 
                        ? `<img src="${airlineData.logo}" class="w-5 h-5 md:w-6 md:h-6 object-contain rounded-sm" title="${f.airline}">`
                        : (f.airline ? `<div class="w-5 h-5 md:w-6 md:h-6 flex items-center justify-center bg-white/10 rounded-sm"><i class="ph-fill ph-airplane text-yellow-400 text-xs"></i></div>` : `<div class="w-5 h-5 md:w-6 md:h-6 flex items-center justify-center bg-white/5 rounded-sm"><i class="ph-bold ph-airplane text-gray-600 text-xs"></i></div>`);
                    
                    const timeHtml = f.time ? `<span class="text-blue-300 font-bold bg-blue-500/10 px-1 py-0.5 rounded ml-1.5 md:ml-2 text-[9px] md:text-[10px]">${f.time}</span>` : '';
                    
                    // Format flight cost or return empty
                    const costHtml = f.cost ? `<span class="text-green-400 font-mono text-[9px] bg-green-900/20 px-1.5 py-0.5 rounded border border-green-500/20">${formatCurrency(f.cost)}</span>` : '';
                    card.innerHTML = `
                        <div class="flex justify-between items-center p-2 md:p-3 bg-white/5 border-b border-white/5">
                            <div class="flex items-center gap-2 md:gap-3">
                                ${logoHtml}
                                <div class="flex flex-col">
                                    <div class="text-[10px] md:text-[11px] font-bold text-gray-200 leading-tight truncate max-w-[80px] md:max-w-none">${f.airline || 'Unknown'}</div>
                                    <div class="text-[8px] md:text-[9px] text-gray-500 font-mono leading-tight flex items-center">
                                        ${f.date}
                                        ${timeHtml}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-1.5 md:gap-2">
                                ${costHtml}
                                <span class="text-[8px] md:text-[9px] font-mono text-gray-600 border border-white/10 px-1 rounded">${f.flightNum || '---'}</span>
                                <button onclick="deleteFlight(${originalIndex})" class="delete-btn text-gray-500 hover:text-red-400 p-1 transition-colors z-20">
                                    <i class="ph-bold ph-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-2 md:p-3 flex items-center justify-between relative">
                            <div class="text-center w-10 md:w-14">
                                <div class="text-lg md:text-xl font-bold text-white tracking-wide">${f.from}</div>
                                <div class="text-[8px] md:text-[9px] text-gray-500 truncate w-full">${start.city}</div>
                            </div>
                            <div class="flex-1 px-1.5 md:px-2 flex flex-col items-center justify-center -mt-1">
                                <div class="text-[8px] md:text-[9px] text-blue-400/80 mb-0.5 md:mb-1 font-mono">${dist.toLocaleString()} km</div>
                                <div class="relative w-full h-[1px] bg-gradient-to-r from-transparent via-white/20 to-transparent">
                                    <i class="ph-fill ph-airplane text-blue-500 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rotate-90 text-[10px] bg-[#141414] px-1"></i>
                                </div>
                            </div>
                            <div class="text-center w-10 md:w-14">
                                <div class="text-lg md:text-xl font-bold text-white tracking-wide">${f.to}</div>
                                <div class="text-[8px] md:text-[9px] text-gray-500 truncate w-full">${end.city}</div>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                }
            });
            setText('total-flights', displayFlights.length);
            setText('total-km', Math.floor(kmTotal / 1000));
            setText('total-countries', uniqueCountries.size);
            
            updateStatsModal(kmTotal, totalCost);
        }
        function updateStatsModal(totalKm, totalCost) {
            const airportCounts = {};
            const airlineCounts = {};
            const yearCounts = {};
            const regionCounts = {};
            let maxDist = 0;
            let minDist = Infinity;
            
            // Jetlag & Layover Tracking
            let totalTimezones = 0;
            let maxHop = 0;
            let brutalHop = null;
            let minConn = Infinity;
            let maxConn = 0;
            let tightConn = null;
            
            // Helper: approx timezone from longitude (15 deg per hour)
            const getTz = (lng) => Math.round(lng / 15);
            // Sort flights for layover calc (clone first)
            const sortedFlights = [...displayFlights].sort((a,b) => {
                const da = new Date(a.date + 'T' + (a.time || '00:00'));
                const db = new Date(b.date + 'T' + (b.time || '00:00'));
                return da - db;
            });
            if (displayFlights.length === 0) minDist = 0;
            displayFlights.forEach(f => {
                airportCounts[f.from] = (airportCounts[f.from] || 0) + 1;
                airportCounts[f.to] = (airportCounts[f.to] || 0) + 1;
                if (f.airline && f.airline.trim() !== "") airlineCounts[f.airline] = (airlineCounts[f.airline] || 0) + 1;
                if (f.date) yearCounts[f.date.split('-')[0]] = (yearCounts[f.date.split('-')[0]] || 0) + 1;
                
                const start = airports[f.from]; const end = airports[f.to];
                if(start && start.region) regionCounts[start.region] = (regionCounts[start.region] || 0) + 1;
                if(end && end.region) regionCounts[end.region] = (regionCounts[end.region] || 0) + 1;
                if(start && end) {
                    const R = 6371; 
                    const distRad = getDistanceRadians(start.lat, start.lng, end.lat, end.lng);
                    const dist = Math.floor(R * distRad);
                    if(dist > maxDist) maxDist = dist;
                    if(dist < minDist) minDist = dist;
                    
                    // Timezones
                    const startTz = getTz(start.lng);
                    const endTz = getTz(end.lng);
                    const diff = Math.abs(endTz - startTz);
                    totalTimezones += diff;
                    if(diff > maxHop) { maxHop = diff; brutalHop = f; }
                }
            });
            
            // Layover Logic
            for(let i=0; i<sortedFlights.length-1; i++) {
                const curr = sortedFlights[i];
                const next = sortedFlights[i+1];
                if(curr.to === next.from) {
                    const s = airports[curr.from]; const e = airports[curr.to];
                    const dist = Math.floor(6371 * getDistanceRadians(s.lat, s.lng, e.lat, e.lng));
                    const estDurationHours = (dist / 800) + 1; // +1h for landing/taxi
                    
                    const arrivalTime = new Date(curr.date + 'T' + (curr.time || '00:00')).getTime() + (estDurationHours * 3600000);
                    const departTime = new Date(next.date + 'T' + (next.time || '00:00')).getTime();
                    
                    const layoverMins = (departTime - arrivalTime) / 60000;
                    if(layoverMins > 30 && layoverMins < 1440) { // Valid connection window
                        if(layoverMins < minConn) { minConn = layoverMins; tightConn = { airport: curr.to, mins: layoverMins }; }
                        if(layoverMins > maxConn) maxConn = layoverMins;
                    }
                }
            }
            // setText('stat-timezones', totalTimezones); // Element removed in HTML but logic kept
            if(brutalHop) {
                setText('stat-brutal-hop', `${maxHop}h Shift`);
                setText('stat-brutal-hop-val', `${brutalHop.from} -> ${brutalHop.to}`);
            } else {
                setText('stat-brutal-hop', '--'); setText('stat-brutal-hop-val', '');
            }
            
            if(tightConn) {
                const h = Math.floor(tightConn.mins/60);
                const m = Math.floor(tightConn.mins%60);
                setText('stat-tight-conn', `${h}h ${m}m`);
                setText('stat-tight-conn-val', `in ${tightConn.airport}`);
            } else {
                setText('stat-tight-conn', '--'); setText('stat-tight-conn-val', '');
            }
            // Personality Logic
            let personality = "The Explorer";
            if (totalKm > 100000) personality = "The Long-Hauler";
            else if (displayFlights.length / Object.keys(regionCounts).length < 2) personality = "The Connector";
            else if (displayFlights.length > 20 && totalKm < 50000) personality = "The Hub Hopper";
            
            setText('stat-personality', personality);
            // setText('pass-personality', personality); // Removed from passport
            // Carbon Footprint
            const co2Kg = Math.floor(totalKm * 0.115);
            const co2Tons = (co2Kg / 1000).toFixed(2);
            const trees = Math.ceil(co2Kg / 20);
            
            setText('stat-co2', `${co2Tons}t CO₂`);
            setText('stat-trees', `${trees} trees offset`);
            // setText('pass-co2', `${co2Tons}t`); // Removed from passport
            // FINANCIALS UPDATE
            setText('stat-total-spent', formatCurrency(totalCost));
            setText('pass-total-cost', formatCurrency(totalCost));
            
            if(totalKm > 0 && totalCost > 0) {
                const cpk = (totalCost / totalKm).toFixed(2);
                setText('stat-cost-km', `₹${cpk} / km`);
            } else {
                setText('stat-cost-km', `₹0 / km`);
            }
            // Fav Airline
            let favAirline = '--'; let maxCount = 0;
            for (const [name, count] of Object.entries(airlineCounts)) { if (count > maxCount) { maxCount = count; favAirline = name; } }
            
            // setText('stat-fav-airline', favAirline); // Removed from stats
            setText('pass-airline', favAirline);
            
            const alData = airlinesData.find(a => a.name === favAirline);
            const passLogo = document.getElementById('pass-airline-logo');
            if(passLogo) {
                if(alData) { passLogo.src = alData.logo; passLogo.classList.remove('hidden'); }
                else { passLogo.classList.add('hidden'); }
            }
            // Achievements
            const achievementsGrid = document.getElementById('achievements-grid');
            if(achievementsGrid) {
                achievementsGrid.innerHTML = '';
                const badges = [
                    { icon: 'ph-globe', text: 'Around the World', earned: totalKm > 40075, desc: '40k+ km' },
                    { icon: 'ph-flag', text: 'Explorer', earned: Object.keys(airportCounts).length >= 5, desc: '5+ Airports' },
                    { icon: 'ph-airplane-tilt', text: 'Frequent Flyer', earned: displayFlights.length >= 10, desc: '10+ Flights' },
                    { icon: 'ph-clock', text: 'Jet Lagged', earned: totalTimezones > 20, desc: '20+ Timezones' }
                ];
                badges.forEach(b => {
                    const opacity = b.earned ? 'opacity-100' : 'opacity-40 grayscale';
                    const bg = b.earned ? 'bg-gradient-to-br from-blue-600 to-blue-900' : 'bg-white/5';
                    achievementsGrid.innerHTML += `<div class="p-2 rounded border border-white/10 ${bg} ${opacity} flex items-center gap-2"><i class="ph-fill ${b.icon} text-xl"></i><div><div class="text-[10px] font-bold uppercase">${b.text}</div><div class="text-[9px] opacity-70">${b.desc}</div></div></div>`;
                });
            }
            // Region Chart
            const regionBars = document.getElementById('region-bars');
            if(regionBars) {
                regionBars.innerHTML = '';
                const totalRegions = Object.values(regionCounts).reduce((a,b) => a+b, 0);
                const regionNames = { 'AS': 'Asia', 'EU': 'Europe', 'NA': 'N. America', 'SA': 'S. America', 'AF': 'Africa', 'OC': 'Oceania' };
                Object.entries(regionCounts).sort((a,b) => b[1] - a[1]).forEach(([code, count]) => {
                    const pct = Math.round((count / totalRegions) * 100);
                    regionBars.innerHTML += `<div class="flex items-center gap-2 text-xs"><div class="w-16 text-gray-400">${regionNames[code] || code}</div><div class="flex-1 h-2 bg-white/10 rounded-full overflow-hidden"><div class="h-full bg-blue-500" style="width: ${pct}%"></div></div><div class="w-8 text-right font-mono">${pct}%</div></div>`;
                });
            }
            // Top Airports
            const sortedAirports = Object.entries(airportCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const airportContainer = document.getElementById('stats-airports');
            if(airportContainer) {
                airportContainer.innerHTML = '';
                sortedAirports.forEach(([code, count], index) => {
                    const city = airports[code] ? airports[code].city : 'Unknown';
                    let rankBadge = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
                    airportContainer.innerHTML += `<div class="flex justify-between items-center p-2 bg-white/5 rounded"><div class="flex items-center gap-2"><span class="text-base">${rankBadge}</span><div><div class="text-sm font-bold text-white">${code}</div><div class="text-[10px] text-gray-400">${city}</div></div></div><div class="text-sm font-semibold text-blue-400">${count} <span class="text-[10px] text-gray-500 font-normal">visits</span></div></div>`;
                });
            }
            
            // Passport Data
            setText('pass-dist', Math.floor(totalKm).toLocaleString() + " km");
            setText('pass-flights', displayFlights.length);
            
            const uniqueCountries = new Set();
            displayFlights.forEach(f => { if(airports[f.from]) uniqueCountries.add(airports[f.from].country); if(airports[f.to]) uniqueCountries.add(airports[f.to].country); });
            setText('pass-countries', uniqueCountries.size);
            
            // Passport Stamps
            const stampsContainer = document.getElementById('pass-stamps');
            if(stampsContainer) {
                stampsContainer.innerHTML = '';
                Array.from(uniqueCountries).slice(0, 12).forEach(country => { // Increased to 12
                    // Generate a "random" color hash for the stamp border
                    const hash = country.split('').reduce((a,b)=>a+b.charCodeAt(0),0);
                    const hue = hash % 360;
                    stampsContainer.innerHTML += `
                        <div class="stamp w-14 h-14 rounded-full border-2 border-dashed flex items-center justify-center text-[8px] text-center uppercase leading-tight transform rotate-${(hash%20)-10}" style="border-color: hsl(${hue}, 70%, 60%); color: hsl(${hue}, 70%, 60%)">
                            ${country.substring(0, 20)}<br>VISITED
                        </div>
                    `;
                });
            }
            
            // Longest/Shortest
            let longestFlight = null;
            let shortestFlight = null;
            let maxDistLocal = 0;
            let minDistLocal = Infinity;
            if(displayFlights.length === 0) minDistLocal = 0;
            displayFlights.forEach(f => {
                const start = airports[f.from]; const end = airports[f.to];
                if(start && end) {
                    const R = 6371; 
                    const dist = Math.floor(R * getDistanceRadians(start.lat, start.lng, end.lat, end.lng));
                    if(dist > maxDistLocal) { maxDistLocal = dist; longestFlight = f; }
                    if(dist < minDistLocal) { minDistLocal = dist; shortestFlight = f; }
                }
            });
            
            if(longestFlight) {
                setText('stat-longest', `${longestFlight.from} - ${longestFlight.to}`);
                setText('stat-longest-dist', `${maxDistLocal.toLocaleString()} km`);
            } else {
                setText('stat-longest', '--');
                setText('stat-longest-dist', '');
            }
            if(shortestFlight && displayFlights.length > 0) {
                setText('stat-shortest', `${shortestFlight.from} - ${shortestFlight.to}`);
                setText('stat-shortest-dist', `${minDistLocal.toLocaleString()} km`);
            } else {
                setText('stat-shortest', '--');
                setText('stat-shortest-dist', '');
            }
            // If the passport modal is open, keep QR in sync with latest stats
            const pm = document.getElementById('passport-modal');
            if (pm && !pm.classList.contains('hidden-modal')) {
                generatePassportQR();
            }
        }
        // --- Screensaver Logic ---
        let idleTime = 0;
        function setupScreensaver() {
            setInterval(() => {
                idleTime++;
                if (idleTime > 30) { // 30s idle
                    document.body.classList.add('screensaver');
                    if (world) world.controls().autoRotateSpeed = 1.5; 
                }
            }, 1000);
            // Reset idle on events
            ['mousemove', 'keydown', 'click', 'scroll'].forEach(evt => {
                document.addEventListener(evt, () => {
                    idleTime = 0;
                    document.body.classList.remove('screensaver');
                    if (world) world.controls().autoRotateSpeed = 0.6; 
                });
            });
        }
        // --- Passport Logic ---
        function fnv1a32(str) {
            let h = 0x811c9dc5;
            for (let i = 0; i < str.length; i++) {
                h ^= str.charCodeAt(i);
                h = Math.imul(h, 0x01000193);
            }
            return ("00000000" + (h >>> 0).toString(16)).slice(-8).toUpperCase();
        }
        function normalizeSpaces(s) {
            return String(s || "").trim().replace(/\s+/g, " ");
        }
        function computePassportStatsFromFlights(flightsArr) {
            let totalKm = 0;
            const countries = new Set();
            const airlineCounts = {};
            flightsArr.forEach(f => {
                const start = airports[f.from];
                const end = airports[f.to];
                if (!start || !end) return;
                const dist = Math.floor(6371 * getDistanceRadians(start.lat, start.lng, end.lat, end.lng));
                totalKm += dist;
                countries.add(start.country);
                countries.add(end.country);
                const al = normalizeSpaces(f.airline || "");
                if (al) airlineCounts[al] = (airlineCounts[al] || 0) + 1;
            });
            const co2Kg = Math.floor(totalKm * 0.115);
            const co2Tons = (co2Kg / 1000);
            let favAirline = "--";
            let maxCount = 0;
            Object.entries(airlineCounts).forEach(([name, count]) => {
                if (count > maxCount) { maxCount = count; favAirline = name; }
            });
            return {
                flights: flightsArr.length,
                totalKm,
                countriesCount: countries.size,
                favAirline,
                co2Tons
            };
        }
        function buildPassportQRPayload() {
            const holder = "Arnav Dugad";
            const passportId = normalizeSpaces(document.getElementById('pass-id')?.innerText || "FL-XXXX-X");
            const issued = new Date().toISOString();
            const stats = computePassportStatsFromFlights(displayFlights);
            const holderShort = holder.toUpperCase().replace(/[^A-Z ]/g, "").slice(0, 16);
            const airlineShort = normalizeSpaces(stats.favAirline).toUpperCase().replace(/[^A-Z0-9 &.\-]/g, "").slice(0, 28);
            const co2 = stats.co2Tons.toFixed(2) + "t";
            const core = `AVP|ID=${passportId}|H=${holderShort}|F=${stats.flights}|KM=${stats.totalKm}|CT=${stats.countriesCount}|AL=${airlineShort}|CO2=${co2}|ISS=${issued}`;
            const sig = fnv1a32(core);
            return `${core}|SIG=${sig}`;
        }
        function setPassportQRFromPayload(payload) {
            const img = document.getElementById('passport-qr-img');
            if (!img) return;
            window.__lastPassportQrPayload = payload;
            const data = encodeURIComponent(payload);
            const bust = Date.now();
            img.style.opacity = "0.0";
            img.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&format=png&margin=10&data=${data}&t=${bust}`;
            img.onload = () => { img.style.opacity = "1"; syncQrViewer(); };
            img.onerror = () => {
                const short = payload.split("|").filter(x => !x.startsWith("ISS=")).join("|");
                const data2 = encodeURIComponent(short);
                img.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&format=png&margin=10&data=${data2}&t=${Date.now()}`;
                img.style.opacity = "1";
                window.__lastPassportQrPayload = short;
                syncQrViewer();
            };
        }
        function generatePassportQR() {
            const payload = buildPassportQRPayload();
            setPassportQRFromPayload(payload);
        }
        // --- QR Viewer (expand) ---
        function syncQrViewer() {
            const modal = document.getElementById('qr-viewer-modal');
            if (!modal || modal.classList.contains('hidden-modal')) return;
            const img = document.getElementById('passport-qr-img');
            const bigImg = document.getElementById('qr-viewer-img');
            const text = document.getElementById('qr-viewer-text');
            if (bigImg && img) bigImg.src = img.src;
            if (text) text.textContent = window.__lastPassportQrPayload || "";
        }
        function openQrViewer() {
            const modal = document.getElementById('qr-viewer-modal');
            if (!modal) return;
            modal.classList.remove('hidden-modal');
            syncQrViewer();
        }
        function closeQrViewer() {
            const modal = document.getElementById('qr-viewer-modal');
            if (!modal) return;
            modal.classList.add('hidden-modal');
        }
        async function copyQrPayload() {
            const payload = window.__lastPassportQrPayload || "";
            try {
                await navigator.clipboard.writeText(payload);
                alert("QR payload copied.");
            } catch (e) {
                const ta = document.createElement('textarea');
                ta.value = payload;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                ta.remove();
                alert("QR payload copied.");
            }
        }
        function downloadQrPng() {
            const img = document.getElementById('passport-qr-img');
            if (!img || !img.src) return;
            const a = document.createElement('a');
            a.href = img.src;
            a.download = 'aviation-passport-qr.png';
            a.click();
        }
        function openPassport() { 
            // Ensure stats are up to date
            updateUI(); 
            const el = document.getElementById('passport-modal');
            if(el) el.classList.remove('hidden-modal'); 
            generatePassportQR();
        }
        function closePassport() { 
            const el = document.getElementById('passport-modal');
            if(el) el.classList.add('hidden-modal'); 
        }
        function waitForImage(img, timeoutMs = 2500) {
            return new Promise(resolve => {
                if (!img) return resolve();
                if (img.complete && img.naturalWidth > 0) return resolve();
                let done = false;
                const finish = () => { if (done) return; done = true; resolve(); };
                const t = setTimeout(finish, timeoutMs);
                img.addEventListener('load', () => { clearTimeout(t); finish(); }, { once: true });
                img.addEventListener('error', () => { clearTimeout(t); finish(); }, { once: true });
            });
        }
        async function downloadPassport() {
            const element = document.getElementById('passport-capture-area');
            if(!element) return;
            // Ensure QR is generated + loaded before capture
            try { generatePassportQR(); } catch(e) {}
            await waitForImage(document.getElementById('passport-qr-img'), 2500);
            html2canvas(element, { backgroundColor: null, scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'my-aviation-passport.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        // --- Data Import/Export ---
        function exportData() {
            const dataStr = JSON.stringify(allFlights, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'my_flight_history.json');
            linkElement.click();
        }
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        allFlights = json;
                        populateYearFilter();
                        filterFlights(); 
                        alert("Import successful!");
                        toggleSettings(); 
                    } else { alert("Invalid file."); }
                } catch (err) { alert("Error parsing JSON."); }
            };
            reader.readAsText(file);
            input.value = ''; 
        }
        function toggleAirports(checkbox) { showAirports = checkbox.checked; updateGlobeData(); }
        function setMapStyle(style) {
            if (!world) return;
            const btnDark = document.getElementById('btn-theme-dark');
            const btnLight = document.getElementById('btn-theme-light');
            if (style === 'light') {
                world.globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                      .backgroundImageUrl(null)
                      .atmosphereColor('lightskyblue');
                document.body.style.backgroundColor = '#1a202c'; 
                if(btnLight) { btnLight.classList.add('bg-blue-600', 'text-white'); btnLight.classList.remove('hover:bg-white/10', 'text-gray-400'); }
                if(btnDark) { btnDark.classList.remove('bg-blue-600', 'text-white'); btnDark.classList.add('hover:bg-white/10', 'text-gray-400'); }
            } else {
                world.globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
                      .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
                      .atmosphereColor('lightskyblue');
                document.body.style.backgroundColor = '#000';
                if(btnDark) { btnDark.classList.add('bg-blue-600', 'text-white'); btnDark.classList.remove('hover:bg-white/10', 'text-gray-400'); }
                if(btnLight) { btnLight.classList.remove('bg-blue-600', 'text-white'); btnLight.classList.add('hover:bg-white/10', 'text-gray-400'); }
            }
        }
        function zoomToHome() { if (world) world.pointOfView({ lat: 22, lng: 78, altitude: 2.0 }, 1500); }
        
        function fitToMap() {
            if(!world || displayFlights.length === 0) return;
            let minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;
            displayFlights.forEach(f => {
                const s = airports[f.from]; const e = airports[f.to];
                if(s && e) {
                    minLat = Math.min(minLat, s.lat, e.lat); maxLat = Math.max(maxLat, s.lat, e.lat);
                    minLng = Math.min(minLng, s.lng, e.lng); maxLng = Math.max(maxLng, s.lng, e.lng);
                }
            });
            world.pointOfView({ lat: (minLat + maxLat)/2, lng: (minLng + maxLng)/2, altitude: 2.5 }, 1500);
        }
        // --- Simple Mobile Gyro Implementation ---
        let gyroEnabled = false;
        function toggleGyro() { // Renamed from enableGyro
             if (gyroEnabled) {
                gyroEnabled = false;
                window.removeEventListener('deviceorientation', handleGyro);
                const status = document.getElementById('gyro-status');
                if(status) {
                    status.innerText = "OFF";
                    status.className = "text-[10px] text-gray-500 uppercase";
                }
                if (world) world.controls().autoRotateSpeed = 0.6; // Reset to default
                return;
            }
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ devices
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            activateGyro();
                        } else {
                            alert('Permission denied');
                        }
                    })
                    .catch(console.error);
            } else {
                // Non-iOS devices
                activateGyro();
            }
        }
        function activateGyro() {
            if (gyroEnabled) return;
            gyroEnabled = true;
            document.getElementById('gyro-status').innerText = "ON";
            document.getElementById('gyro-status').className = "text-[10px] text-green-400 font-bold uppercase";
            
            window.addEventListener('deviceorientation', handleGyro);
            alert("Motion control enabled! Tilt phone left/right to spin.");
        }
        function handleGyro(event) {
            if (!world || !autoRotate) return;
            
            // Gamma is left/right tilt in degrees (roughly -90 to 90)
            const tilt = event.gamma; 
            if (tilt === null) return;
            // Map tilt to rotation speed
            // Flat (0) = normal speed (0.6)
            // Left tilt (-ve) = faster or reverse
            // Right tilt (+ve) = faster
            
            const baseSpeed = 0.5;
            const sensitivity = 0.05;
            
            const newSpeed = baseSpeed + (tilt * sensitivity);
            world.controls().autoRotateSpeed = newSpeed;
        }
    </script>
</body>
</html>